---
/**
 * Localized Link component for Astro
 *
 * Automatically detects whether locale prefix is needed based on current URL.
 *
 * @example
 * ```astro
 * import Link from '@i18n-tiny/astro/router/Link.astro'
 *
 * // Auto-localized (maintains current URL pattern)
 * <Link href="/about">About</Link>
 *
 * // Language switch with explicit locale
 * <Link href="/" locale="ja">日本語</Link>
 *
 * // Raw path (no localization)
 * <Link href="/" locale="">English</Link>
 * ```
 */
import type { HTMLAttributes } from 'astro/types'

interface Props extends HTMLAttributes<'a'> {
  /** The path to navigate to */
  href: string
  /**
   * Override the locale for this link
   * - undefined: auto-localize based on current URL (default)
   * - string (e.g., 'ja'): generate path with specified locale prefix
   * - '' (empty string): use href as-is without any localization
   */
  locale?: string
}

const { href, locale, ...attrs } = Astro.props

// Get current locale from route params
const currentLocale = Astro.params.locale as string | undefined
const pathname = Astro.url.pathname

// Check if current URL has locale prefix
const hasExplicitLocale = currentLocale
  ? pathname.startsWith(`/${currentLocale}/`) || pathname === `/${currentLocale}`
  : false

// Generate localized href
const cleanPath = href.startsWith('/') ? href : `/${href}`
let localizedHref: string

if (locale === '') {
  // locale="" → raw path (no localization)
  localizedHref = cleanPath
} else if (locale !== undefined) {
  // locale="ja" → explicit locale prefix
  localizedHref = cleanPath === '/' ? `/${locale}` : `/${locale}${cleanPath}`
} else if (hasExplicitLocale && currentLocale) {
  // Auto-localize: current URL has prefix → add prefix
  localizedHref = cleanPath === '/' ? `/${currentLocale}` : `/${currentLocale}${cleanPath}`
} else {
  // Auto-localize: current URL has no prefix → no prefix
  localizedHref = cleanPath
}
---

<a href={localizedHref} {...attrs}>
  <slot />
</a>
